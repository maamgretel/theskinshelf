<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=yes">
    <title>My Product Orders - Enhanced View</title>
    <link rel="stylesheet" href="https://stackpath.bootstrapcdn.com/bootstrap/4.5.2/css/bootstrap.min.css">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
    <style>
        /* Custom Styles */
        .order-card {
            border: 1px solid #e3f2fd;
            border-radius: 12px;
            margin-bottom: 1rem;
            transition: all 0.3s ease;
            box-shadow: 0 2px 8px rgba(0,0,0,0.08);
        }

        .order-card:hover {
            box-shadow: 0 4px 16px rgba(0,0,0,0.12);
            transform: translateY(-2px);
        }

        .order-header {
            background: linear-gradient(135deg, #e3f2fd 0%, #bbdefb 100%);
            border-radius: 12px 12px 0 0;
            padding: 1rem 1.5rem;
            cursor: pointer;
            border-bottom: 1px solid rgba(33, 150, 243, 0.2);
            transition: all 0.3s ease;
        }

        .order-header:hover {
            background: linear-gradient(135deg, #bbdefb 0%, #90caf9 100%);
        }

        .order-header.collapsed {
            border-radius: 12px;
        }

        .order-number {
            font-size: 1.1rem;
            font-weight: 700;
            color: #1976d2;
        }

        .order-meta {
            font-size: 0.9rem;
            color: #546e7a;
        }

        .order-summary {
            display: flex;
            align-items: center;
            gap: 1rem;
        }

        .collapse-icon {
            transition: transform 0.3s ease;
            color: #1976d2;
        }

        .collapsed .collapse-icon {
            transform: rotate(-90deg);
        }

        .order-content {
            padding: 1.5rem;
            background: #fff;
            border-radius: 0 0 12px 12px;
        }

        .product-item {
            background: #f8f9fa;
            border-radius: 8px;
            padding: 1rem;
            margin-bottom: 1rem;
            border-left: 4px solid #2196f3;
            display: flex;
            gap: 1rem;
            align-items: flex-start;
        }

        .product-item:last-child {
            margin-bottom: 0;
        }

        .product-image {
            width: 80px;
            height: 80px;
            border-radius: 8px;
            object-fit: cover;
            flex-shrink: 0;
            border: 2px solid #e9ecef;
            background: #f8f9fa;
        }

        .product-image.placeholder {
            display: flex;
            align-items: center;
            justify-content: center;
            color: #6c757d;
            font-size: 24px;
        }

        .product-content {
            flex: 1;
            min-width: 0;
        }

        .product-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 0.5rem;
        }

        .product-name {
            font-weight: 600;
            color: #333;
            display: flex;
            align-items: center;
            gap: 0.5rem;
        }

        .quantity-badge {
            background: #2196f3;
            color: white;
            padding: 0.2rem 0.6rem;
            border-radius: 12px;
            font-size: 0.8rem;
            font-weight: 600;
        }

        .product-price {
            font-weight: 700;
            color: #2e7d32;
        }

        .product-details {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));
            gap: 0.5rem;
            font-size: 0.9rem;
            color: #666;
            margin-bottom: 1rem;
        }

        .status-update-form {
            display: flex;
            gap: 0.5rem;
            align-items: center;
            flex-wrap: wrap;
        }

        .status-select {
            min-width: 140px;
        }

        .bulk-actions {
            background: linear-gradient(135deg, #f1f8e9 0%, #dcedc8 100%);
            border-radius: 8px;
            padding: 1rem;
            margin-top: 1.5rem;
            border-left: 4px solid #4caf50;
        }

        .stats-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 1rem;
            margin-bottom: 2rem;
        }

        .stat-card {
            border: none;
            border-radius: 12px;
            box-shadow: 0 4px 16px rgba(0,0,0,0.1);
            transition: transform 0.3s ease;
        }

        .stat-card:hover {
            transform: translateY(-3px);
        }

        .stat-card.primary {
            background: linear-gradient(135deg, #1976d2 0%, #1565c0 100%);
        }

        .stat-card.info {
            background: linear-gradient(135deg, #0288d1 0%, #0277bd 100%);
        }

        .stat-card.warning {
            background: linear-gradient(135deg, #f57c00 0%, #ef6c00 100%);
        }

        .stat-card.success {
            background: linear-gradient(135deg, #388e3c 0%, #2e7d32 100%);
        }

        .badge {
            font-size: 0.8rem;
            padding: 0.4rem 0.8rem;
            border-radius: 20px;
        }

        .btn-sm {
            padding: 0.375rem 0.75rem;
            font-size: 0.875rem;
        }

        .loading-spinner {
            display: flex;
            justify-content: center;
            align-items: center;
            min-height: 200px;
        }

        /* Mobile Responsive */
        @media (max-width: 768px) {
            .order-summary {
                flex-direction: column;
                align-items: flex-start;
                gap: 0.5rem;
            }

            .product-item {
                flex-direction: column;
                text-align: center;
            }

            .product-image {
                align-self: center;
            }

            .product-details {
                grid-template-columns: 1fr;
            }

            .status-update-form {
                flex-direction: column;
                align-items: stretch;
            }

            .bulk-actions .btn {
                width: 100%;
                margin: 0.25rem 0;
            }
        }

        .alert-container {
            position: fixed;
            top: 20px;
            right: 20px;
            z-index: 1050;
            max-width: 350px;
        }

        .alert {
            border-radius: 8px;
            box-shadow: 0 4px 12px rgba(0,0,0,0.15);
            animation: slideIn 0.3s ease;
        }

        @keyframes slideIn {
            from {
                transform: translateX(100%);
                opacity: 0;
            }
            to {
                transform: translateX(0);
                opacity: 1;
            }
        }
    </style>
</head>
<body>
    <div class="container-fluid mt-2">
        <!-- Header Section -->
        <div class="row mb-3">
            <div class="col-12">
                <div class="d-flex justify-content-between align-items-center mb-3">
                    <div>
                        <h2><i class="fas fa-shopping-cart text-primary"></i> Orders Management</h2>
                        <p class="text-muted">Manage your product orders with enhanced product grouping</p>
                    </div>
                    <div class="btn-group">
                        <a href="seller_dashboard.html" class="btn btn-secondary">
                            <i class="fas fa-arrow-left"></i> <span class="d-none d-sm-inline">Dashboard</span>
                        </a>
                        <button id="expandAllBtn" class="btn btn-info">
                            <i class="fas fa-expand-alt"></i> <span class="d-none d-sm-inline">Expand All</span>
                        </button>
                        <button id="exportCsvBtn" class="btn btn-success">
                            <i class="fas fa-download"></i> <span class="d-none d-sm-inline">Export CSV</span>
                        </button>
                    </div>
                </div>
            </div>
        </div>

        <!-- Alert Container -->
        <div id="alert-container" class="alert-container"></div>

        <!-- Statistics Cards -->
        <div class="stats-grid">
            <div class="card stat-card primary text-white">
                <div class="card-body">
                    <div class="d-flex justify-content-between">
                        <div>
                            <h6 class="card-title mb-1">Total Revenue</h6>
                            <h4 id="totalRevenueCell">‚Ç±0.00</h4>
                        </div>
                        <div class="align-self-center">
                            <i class="fas fa-peso-sign fa-2x opacity-75"></i>
                        </div>
                    </div>
                </div>
            </div>
            <div class="card stat-card info text-white">
                <div class="card-body">
                    <div class="d-flex justify-content-between">
                        <div>
                            <h6 class="card-title mb-1">Total Orders</h6>
                            <h4 id="totalOrdersCell">0</h4>
                        </div>
                        <div class="align-self-center">
                            <i class="fas fa-shopping-bag fa-2x opacity-75"></i>
                        </div>
                    </div>
                </div>
            </div>
            <div class="card stat-card warning text-white">
                <div class="card-body">
                    <div class="d-flex justify-content-between">
                        <div>
                            <h6 class="card-title mb-1">Pending Orders</h6>
                            <h4 id="pendingOrdersCell">0</h4>
                        </div>
                        <div class="align-self-center">
                            <i class="fas fa-clock fa-2x opacity-75"></i>
                        </div>
                    </div>
                </div>
            </div>
            <div class="card stat-card success text-white">
                <div class="card-body">
                    <div class="d-flex justify-content-between">
                        <div>
                            <h6 class="card-title mb-1">Delivered Orders</h6>
                            <h4 id="deliveredOrdersCell">0</h4>
                        </div>
                        <div class="align-self-center">
                            <i class="fas fa-check-circle fa-2x opacity-75"></i>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Orders Container -->
        <div class="row">
            <div class="col-12">
                <h5 class="mb-3">
                    <i class="fas fa-list-ul"></i> Order Details
                    <small class="text-muted ml-2" id="orderCount">Loading...</small>
                </h5>
                <div id="ordersContainer">
                    <div class="loading-spinner">
                        <div class="spinner-border text-primary" role="status">
                            <span class="sr-only">Loading orders...</span>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Help Section -->
        <div class="row mt-4">
            <div class="col-12">
                <div class="card bg-light">
                    <div class="card-body">
                        <h6><i class="fas fa-info-circle"></i> How to Use:</h6>
                        <ul class="mb-0">
                            <li>Click on any order header to expand/collapse details</li>
                            <li>Products are automatically grouped by name with quantity indicators</li>
                            <li>Update individual product status using the dropdown and "Update" button</li>
                            <li>Use "Ship All Pending" to mark all pending items as shipped</li>
                            <li>Use "Mark All Delivered" to mark all items as delivered</li>
                        </ul>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Bootstrap Modal for Progress -->
    <div class="modal fade" id="progressModal" tabindex="-1" role="dialog" data-backdrop="static" data-keyboard="false">
        <div class="modal-dialog modal-dialog-centered" role="document">
            <div class="modal-content">
                <div class="modal-header bg-primary text-white">
                    <h5 class="modal-title">üì¶ Processing Orders</h5>
                </div>
                <div class="modal-body">
                    <div class="text-center mb-3">
                        <div id="progressTitle" class="h5">Processing your request...</div>
                        <div id="progressSubtitle" class="text-muted">Please wait while we update your orders</div>
                    </div>
                    
                    <div class="progress mb-3" style="height: 25px;">
                        <div id="progressBar" class="progress-bar progress-bar-striped progress-bar-animated bg-success" 
                            role="progressbar" style="width: 0%">
                            <span id="progressText">0%</span>
                        </div>
                    </div>
                    
                    <div class="row">
                        <div class="col-md-6">
                            <div class="card bg-light">
                                <div class="card-body text-center py-2">
                                    <div id="currentProgress" class="h4 text-primary mb-0">0/0</div>
                                    <small class="text-muted">Progress</small>
                                </div>
                            </div>
                        </div>
                        <div class="col-md-6">
                            <div class="card bg-light">
                                <div class="card-body text-center py-2">
                                    <div id="successCount" class="h4 text-success mb-0">0</div>
                                    <small class="text-muted">Completed</small>
                                </div>
                            </div>
                        </div>
                    </div>
                    
                    <div id="statusMessages" class="mt-3" style="max-height: 200px; overflow-y: auto;"></div>
                </div>
                <div class="modal-footer" id="modalFooter" style="display: none;">
                    <button type="button" class="btn btn-secondary" data-dismiss="modal">Close</button>
                </div>
            </div>
        </div>
    </div>

    <script src="https://code.jquery.com/jquery-3.5.1.min.js"></script>
    <script src="https://stackpath.bootstrapcdn.com/bootstrap/4.5.2/js/bootstrap.min.js"></script>
    <script>
        // Application State
        const BACKEND_URL = 'https://backend-rj0a.onrender.com';
        const user = JSON.parse(localStorage.getItem('user'));
        let ordersData = [];
        let expandedOrders = new Set();

        // Security check
        if (!user || user.role !== 'seller') {
            localStorage.clear();
            alert('Access Denied. Please log in as a seller.');
            window.location.href = '../../pages/login.html';
        }

        // DOM Elements
        const ordersContainer = document.getElementById('ordersContainer');
        const totalRevenueCell = document.getElementById('totalRevenueCell');
        const totalOrdersCell = document.getElementById('totalOrdersCell');
        const pendingOrdersCell = document.getElementById('pendingOrdersCell');
        const deliveredOrdersCell = document.getElementById('deliveredOrdersCell');
        const orderCount = document.getElementById('orderCount');
        const expandAllBtn = document.getElementById('expandAllBtn');
        const exportCsvBtn = document.getElementById('exportCsvBtn');
        const alertContainer = document.getElementById('alert-container');

        // Utility Functions
        function showAlert(message, type = 'info', duration = 3000) {
            const alert = document.createElement('div');
            alert.className = `alert alert-${type} alert-dismissible fade show`;
            alert.innerHTML = `
                ${message}
                <button type="button" class="close" data-dismiss="alert">
                    <span aria-hidden="true">&times;</span>
                </button>
            `;
            alertContainer.appendChild(alert);
            setTimeout(() => alert.remove(), duration);
        }

        function getStatusBadgeColor(status) {
            const colors = {
                'Pending': 'warning',
                'Shipped': 'info', 
                'Delivered': 'success',
                'Cancelled': 'danger'
            };
            return colors[status] || 'secondary';
        }

        function formatDate(dateString) {
            return new Date(dateString).toLocaleDateString('en-US', {
                year: 'numeric',
                month: 'short',
                day: 'numeric'
            });
        }

        function formatTime(dateString) {
            return new Date(dateString).toLocaleTimeString('en-US', {
                hour: '2-digit',
                minute: '2-digit'
            });
        }

        function getProductImage(productName, productId) {
            // Return a placeholder or try to construct image URL based on your backend structure
            return `${BACKEND_URL}/uploads/products/${productId}.jpg`;
        }

        function createImageElement(src, alt, productId) {
            const img = document.createElement('img');
            img.className = 'product-image';
            img.alt = alt;
            
            // Create placeholder div
            const placeholder = document.createElement('div');
            placeholder.className = 'product-image placeholder';
            placeholder.innerHTML = '<i class="fas fa-image"></i>';
            
            img.onload = function() {
                placeholder.replaceWith(img);
            };
            
            img.onerror = function() {
                // Keep placeholder if image fails to load
            };
            
            img.src = src;
            return placeholder;
        }

        // Progress Modal Functions
        function showProgressModal(title, subtitle) {
            document.getElementById('progressTitle').textContent = title;
            document.getElementById('progressSubtitle').textContent = subtitle;
            $('#progressModal').modal('show');
        }

        function updateProgress(current, total, message = '') {
            const percentage = Math.round((current / total) * 100);
            
            const progressBar = document.getElementById('progressBar');
            const progressText = document.getElementById('progressText');
            const currentProgress = document.getElementById('currentProgress');
            
            progressBar.style.width = `${percentage}%`;
            progressText.textContent = `${percentage}%`;
            currentProgress.textContent = `${current}/${total}`;
            
            if (message) addStatusMessage(message, 'info');
        }

        function addStatusMessage(message, type = 'info') {
            const statusMessages = document.getElementById('statusMessages');
            const timestamp = new Date().toLocaleTimeString();
            const icons = { 'info': 'üìã', 'success': '‚úÖ', 'warning': '‚ö†Ô∏è', 'danger': '‚ùå' };
            
            const messageElement = document.createElement('div');
            messageElement.className = `alert alert-${type} alert-sm py-1 px-2 mb-1`;
            messageElement.innerHTML = `
                <small>
                    <span class="text-muted">${timestamp}</span> - 
                    ${icons[type]} ${message}
                </small>
            `;
            
            statusMessages.appendChild(messageElement);
            statusMessages.scrollTop = statusMessages.scrollHeight;
        }

        function completeProgress(success, message) {
            const progressBar = document.getElementById('progressBar');
            const progressTitle = document.getElementById('progressTitle');
            const modalFooter = document.getElementById('modalFooter');
            
            progressBar.classList.remove('progress-bar-animated', 'progress-bar-striped');
            progressBar.classList.add(success ? 'bg-success' : 'bg-danger');
            progressTitle.textContent = success ? 'üéâ Process Complete!' : '‚ùå Process Failed';
            modalFooter.style.display = 'block';
            
            addStatusMessage(message, success ? 'success' : 'danger');
        }

        // Data fetching and processing
        async function fetchOrders() {
            try {
                const response = await fetch(`${BACKEND_URL}/api/seller/orders`, {
                    headers: { 'X-User-ID': user.id }
                });
                
                if (!response.ok) {
                    throw new Error('Failed to fetch orders');
                }
                
                const orders = await response.json();
                ordersData = processOrdersData(orders);
                renderOrders();
                updateStatistics();
                
            } catch (error) {
                console.error('Error fetching orders:', error);
                ordersContainer.innerHTML = `
                    <div class="alert alert-danger">
                        <i class="fas fa-exclamation-triangle"></i> 
                        Error loading orders: ${error.message}
                    </div>
                `;
            }
        }

        function processOrdersData(orders) {
            // Group orders by buyer and date
            const grouped = {};
            
            orders.forEach(order => {
                const key = `${order.buyer_id}-${formatDate(order.order_date)}`;
                
                if (!grouped[key]) {
                    grouped[key] = {
                        orderId: `ORD-${Date.now()}-${Object.keys(grouped).length + 1}`,
                        buyerId: order.buyer_id,
                        buyerName: order.buyer_name,
                        orderDate: order.order_date,
                        formattedDate: formatDate(order.order_date),
                        products: new Map(), // Use Map to group identical products
                        totalAmount: 0,
                        hasAllShipped: true,
                        hasAllDelivered: true,
                        hasPending: false
                    };
                }
                
                const productKey = `${order.product_name}-${order.status}`;
                
                if (grouped[key].products.has(productKey)) {
                    // Product with same name and status exists, increment quantity and update total price
                    const existingProduct = grouped[key].products.get(productKey);
                    existingProduct.quantity += 1;
                    existingProduct.totalPrice += parseFloat(order.total_price);
                    existingProduct.orders.push({
                        id: order.id,
                        individualPrice: parseFloat(order.total_price),
                        formattedTime: formatTime(order.order_date)
                    });
                } else {
                    // New product entry
                    grouped[key].products.set(productKey, {
                        productId: order.product_id,
                        productName: order.product_name,
                        totalPrice: parseFloat(order.total_price),
                        status: order.status,
                        quantity: 1,
                        orders: [{
                            id: order.id,
                            individualPrice: parseFloat(order.total_price),
                            formattedTime: formatTime(order.order_date)
                        }],
                        image: order.product_image || null
                    });
                }
                
                grouped[key].totalAmount += parseFloat(order.total_price);
                
                if (order.status !== 'Shipped') grouped[key].hasAllShipped = false;
                if (order.status !== 'Delivered') grouped[key].hasAllDelivered = false;
                if (order.status === 'Pending') grouped[key].hasPending = true;
            });
            
            // Convert Map back to array for easier handling
            Object.values(grouped).forEach(order => {
                order.products = Array.from(order.products.values());
            });
            
            return Object.values(grouped);
        }

        function updateStatistics() {
            let totalRevenue = 0;
            let totalOrders = 0;
            let pendingOrders = 0;
            let deliveredOrders = 0;
            
            ordersData.forEach(order => {
                order.products.forEach(product => {
                    totalRevenue += product.totalPrice;
                    totalOrders += product.quantity;
                    if (product.status === 'Pending') pendingOrders += product.quantity;
                    if (product.status === 'Delivered') deliveredOrders += product.quantity;
                });
            });
            
            totalRevenueCell.textContent = `‚Ç±${totalRevenue.toFixed(2)}`;
            totalOrdersCell.textContent = totalOrders;
            pendingOrdersCell.textContent = pendingOrders;
            deliveredOrdersCell.textContent = deliveredOrders;
            orderCount.textContent = `${ordersData.length} order groups`;
        }

        function renderOrders() {
            if (ordersData.length === 0) {
                ordersContainer.innerHTML = `
                    <div class="text-center py-5">
                        <i class="fas fa-shopping-cart fa-4x text-muted mb-3"></i>
                        <h5 class="text-muted">No orders found</h5>
                        <p class="text-muted">Orders will appear here when customers make purchases</p>
                    </div>
                `;
                return;
            }

            const ordersHtml = ordersData.map(order => {
                const isExpanded = expandedOrders.has(order.orderId);
                const totalQuantity = order.products.reduce((sum, product) => sum + product.quantity, 0);
                
                return `
                    <div class="order-card">
                        <div class="order-header ${isExpanded ? '' : 'collapsed'}" onclick="toggleOrder('${order.orderId}')">
                            <div class="d-flex justify-content-between align-items-center">
                                <div class="order-summary">
                                    <div>
                                        <div class="order-number">üì¶ ${order.orderId}</div>
                                        <div class="order-meta">
                                            üë§ <strong>${order.buyerName}</strong> ‚Ä¢ 
                                            üìÖ ${order.formattedDate} ‚Ä¢ 
                                            üí∞ ‚Ç±${order.totalAmount.toFixed(2)} ‚Ä¢ 
                                            üì¶ ${totalQuantity} items (${order.products.length} unique)
                                        </div>
                                    </div>
                                </div>
                                <div class="d-flex align-items-center">
                                    <span class="mr-2">
                                        ${order.hasAllDelivered ? '<span class="badge badge-success">All Delivered</span>' : ''}
                                        ${order.hasAllShipped && !order.hasAllDelivered ? '<span class="badge badge-info">All Shipped</span>' : ''}
                                        ${order.hasPending ? '<span class="badge badge-warning">Has Pending</span>' : ''}
                                    </span>
                                    <i class="fas fa-chevron-down collapse-icon"></i>
                                </div>
                            </div>
                        </div>
                        
                        <div class="collapse ${isExpanded ? 'show' : ''}" id="order-${order.orderId}">
                            <div class="order-content">
                                ${order.products.map(product => `
                                    <div class="product-item">
                                        ${createImageElement(
                                            getProductImage(product.productName, product.productId), 
                                            product.productName,
                                            product.productId
                                        ).outerHTML}
                                        
                                        <div class="product-content">
                                            <div class="product-header">
                                                <div class="product-name">
                                                    ${product.productName}
                                                    ${product.quantity > 1 ? `<span class="quantity-badge">√ó${product.quantity}</span>` : ''}
                                                </div>
                                                <div class="product-price">‚Ç±${product.totalPrice.toFixed(2)}</div>
                                            </div>
                                            <div class="product-details">
                                                <div>üïê <strong>Time:</strong> ${product.orders[0].formattedTime}</div>
                                                <div>üìã <strong>Status:</strong> <span class="badge badge-${getStatusBadgeColor(product.status)}">${product.status}</span></div>
                                                ${product.quantity > 1 ? `<div>üì¶ <strong>Quantity:</strong> ${product.quantity} items</div>` : ''}
                                                ${product.quantity > 1 ? `<div>üí∞ <strong>Per Item:</strong> ‚Ç±${(product.totalPrice / product.quantity).toFixed(2)}</div>` : ''}
                                            </div>
                                            <div class="status-update-form">
                                                <select class="form-control status-select" data-product-orders="${product.orders.map(o => o.id).join(',')}">
                                                    <option value="Pending" ${product.status === 'Pending' ? 'selected' : ''}>üïê Pending</option>
                                                    <option value="Shipped" ${product.status === 'Shipped' ? 'selected' : ''}>üöö Shipped</option>
                                                    <option value="Delivered" ${product.status === 'Delivered' ? 'selected' : ''}>‚úÖ Delivered</option>
                                                    <option value="Cancelled" ${product.status === 'Cancelled' ? 'selected' : ''}>‚ùå Cancelled</option>
                                                </select>
                                                <button class="btn btn-primary btn-sm update-btn" data-product-orders="${product.orders.map(o => o.id).join(',')}">
                                                    Update ${product.quantity > 1 ? `All (${product.quantity})` : ''}
                                                </button>
                                            </div>
                                        </div>
                                    </div>
                                `).join('')}
                                
                                <div class="bulk-actions">
                                    <div class="d-flex flex-wrap gap-2">
                                        <h6 class="w-100 mb-2">
                                            <i class="fas fa-layer-group"></i> Bulk Actions
                                        </h6>
                                        <div class="d-flex flex-wrap gap-2 w-100">
                                            ${order.hasPending ? `
                                                <button class="btn btn-success btn-sm bulk-ship-btn" 
                                                        data-order-id="${order.orderId}">
                                                    üì¶ Ship All Pending
                                                </button>
                                            ` : ''}
                                            <button class="btn btn-info btn-sm bulk-deliver-btn" 
                                                    data-order-id="${order.orderId}">
                                                ‚úÖ Mark All Delivered
                                            </button>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                `;
            }).join('');

            ordersContainer.innerHTML = ordersHtml;
        }

        function toggleOrder(orderId) {
            const orderElement = document.getElementById(`order-${orderId}`);
            const headerElement = orderElement.previousElementSibling;
            
            if (expandedOrders.has(orderId)) {
                expandedOrders.delete(orderId);
                $(orderElement).collapse('hide');
                headerElement.classList.add('collapsed');
            } else {
                expandedOrders.add(orderId);
                $(orderElement).collapse('show');
                headerElement.classList.remove('collapsed');
            }
        }

        // Order management functions
        async function updateProductStatus(orderIds, newStatus) {
            const orders = orderIds.split(',').map(id => parseInt(id));
            
            try {
                showAlert(`Updating status for ${orders.length} item(s)...`, 'info');
                
                let successCount = 0;
                let errorCount = 0;
                
                for (const orderId of orders) {
                    try {
                        const response = await fetch(`${BACKEND_URL}/api/orders/${orderId}/status`, {
                            method: 'PUT',
                            headers: {
                                'Content-Type': 'application/json',
                                'X-User-ID': user.id
                            },
                            body: JSON.stringify({ status: newStatus })
                        });

                        if (response.ok) {
                            successCount++;
                        } else {
                            errorCount++;
                            console.error(`Failed to update order ${orderId}`);
                        }
                    } catch (error) {
                        errorCount++;
                        console.error(`Error updating order ${orderId}:`, error);
                    }
                }
                
                if (successCount > 0) {
                    showAlert(`Successfully updated ${successCount} item(s) to ${newStatus}!`, 'success');
                }
                
                if (errorCount > 0) {
                    showAlert(`Failed to update ${errorCount} item(s)`, 'warning');
                }
                
                fetchOrders(); // Refresh the display
                
            } catch (error) {
                console.error('Error updating status:', error);
                showAlert('Failed to update status', 'danger');
            }
        }

        async function bulkUpdateOrder(orderId, action) {
            const order = ordersData.find(o => o.orderId === orderId);
            if (!order) return;

            // Collect all order IDs that need to be updated
            let allOrderIds = [];
            
            if (action === 'ship') {
                // Only pending orders
                order.products.forEach(product => {
                    if (product.status === 'Pending') {
                        allOrderIds = allOrderIds.concat(product.orders.map(o => o.id));
                    }
                });
            } else {
                // All orders
                order.products.forEach(product => {
                    allOrderIds = allOrderIds.concat(product.orders.map(o => o.id));
                });
            }

            if (allOrderIds.length === 0) {
                showAlert('No applicable products found for this action', 'warning');
                return;
            }

            const targetStatus = action === 'ship' ? 'Shipped' : 'Delivered';
            const actionName = action === 'ship' ? 'Shipping' : 'Delivering';
            
            showProgressModal(
                `${actionName} ${allOrderIds.length} Items`,
                `Processing order ${orderId}`
            );

            let successCount = 0;
            
            for (let i = 0; i < allOrderIds.length; i++) {
                const orderItemId = allOrderIds[i];
                
                try {
                    const response = await fetch(`${BACKEND_URL}/api/orders/${orderItemId}/status`, {
                        method: 'PUT',
                        headers: {
                            'Content-Type': 'application/json',
                            'X-User-ID': user.id
                        },
                        body: JSON.stringify({ status: targetStatus })
                    });

                    if (response.ok) {
                        successCount++;
                        updateProgress(i + 1, allOrderIds.length, `Item ${i + 1} updated to ${targetStatus}`);
                        document.getElementById('successCount').textContent = successCount;
                    } else {
                        const error = await response.json();
                        addStatusMessage(`Failed to update item ${i + 1}: ${error.error}`, 'warning');
                    }
                } catch (error) {
                    addStatusMessage(`Error updating item ${i + 1}: ${error.message}`, 'danger');
                }
                
                // Small delay between requests
                if (i < allOrderIds.length - 1) {
                    await new Promise(resolve => setTimeout(resolve, 200));
                }
            }
            
            setTimeout(() => {
                const wasSuccessful = successCount === allOrderIds.length;
                completeProgress(
                    wasSuccessful, 
                    wasSuccessful 
                        ? `Successfully ${action === 'ship' ? 'shipped' : 'delivered'} ${successCount} items!`
                        : `Completed with ${successCount}/${allOrderIds.length} successful updates`
                );
                
                setTimeout(() => {
                    $('#progressModal').modal('hide');
                    fetchOrders(); // Refresh the display
                }, 2000);
            }, 500);
        }

        function exportToCsv() {
            if (ordersData.length === 0) {
                showAlert('No orders to export', 'warning');
                return;
            }

            const headers = ['Order ID', 'Product', 'Buyer', 'Quantity', 'Total Price', 'Price Per Item', 'Date', 'Time', 'Status'];
            const csvRows = [headers.join(',')];

            ordersData.forEach(order => {
                order.products.forEach(product => {
                    const row = [
                        order.orderId,
                        `"${product.productName.replace(/"/g, '""')}"`,
                        `"${order.buyerName.replace(/"/g, '""')}"`,
                        product.quantity,
                        product.totalPrice.toFixed(2),
                        (product.totalPrice / product.quantity).toFixed(2),
                        order.formattedDate,
                        product.orders[0].formattedTime,
                        product.status
                    ];
                    csvRows.push(row.join(','));
                });
            });

            // Add summary
            const totalRevenue = ordersData.reduce((sum, order) => 
                sum + order.products.reduce((pSum, product) => pSum + product.totalPrice, 0), 0
            );
            const totalItems = ordersData.reduce((sum, order) => 
                sum + order.products.reduce((pSum, product) => pSum + product.quantity, 0), 0
            );
            
            csvRows.push(['', 'SUMMARY', '', '', '', '', '', '', ''].join(','));
            csvRows.push(['', 'Total Revenue', '', '', totalRevenue.toFixed(2), '', '', '', ''].join(','));
            csvRows.push(['', 'Total Items', '', totalItems, '', '', '', '', ''].join(','));
            
            const csvString = csvRows.join('\n');
            const blob = new Blob([csvString], { type: 'text/csv;charset=utf-8;' });
            
            const link = document.createElement('a');
            const url = URL.createObjectURL(blob);
            link.setAttribute('href', url);
            link.setAttribute('download', `seller_orders_${new Date().toISOString().split('T')[0]}.csv`);
            link.style.visibility = 'hidden';
            document.body.appendChild(link);
            link.click();
            document.body.removeChild(link);
            
            showAlert('Orders exported successfully!', 'success');
        }

        // Event Listeners
        document.addEventListener('click', (e) => {
            if (e.target.classList.contains('update-btn')) {
                const orderIds = e.target.dataset.productOrders;
                const selectElement = document.querySelector(`.status-select[data-product-orders="${orderIds}"]`);
                const newStatus = selectElement.value;
                updateProductStatus(orderIds, newStatus);
            }
            
            if (e.target.classList.contains('bulk-ship-btn')) {
                const orderId = e.target.dataset.orderId;
                bulkUpdateOrder(orderId, 'ship');
            }
            
            if (e.target.classList.contains('bulk-deliver-btn')) {
                const orderId = e.target.dataset.orderId;
                bulkUpdateOrder(orderId, 'deliver');
            }
        });

        expandAllBtn.addEventListener('click', () => {
            const shouldExpandAll = expandedOrders.size < ordersData.length;
            
            if (shouldExpandAll) {
                ordersData.forEach(order => expandedOrders.add(order.orderId));
                expandAllBtn.innerHTML = '<i class="fas fa-compress-alt"></i> <span class="d-none d-sm-inline">Collapse All</span>';
            } else {
                expandedOrders.clear();
                expandAllBtn.innerHTML = '<i class="fas fa-expand-alt"></i> <span class="d-none d-sm-inline">Expand All</span>';
            }
            
            renderOrders();
        });

        exportCsvBtn.addEventListener('click', exportToCsv);

        // Global function for toggling orders (called from onclick)
        window.toggleOrder = toggleOrder;

        // Initialize the application
        fetchOrders();
    </script>
</body>
</html>